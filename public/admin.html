<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Poker • Admin</title>
<link rel="stylesheet" href="/app.css">
<style>
  :root{ --bg:#0b0d13; --panel:#111722; --muted:#94a3b8; --br:#243041; --btn:#22d3ee; }
  body{ margin:0; background:var(--bg); color:#e5e7eb; font:14px/1.4 system-ui,Segoe UI,Roboto,Arial,sans-serif; }
  .wrap{ max-width:980px; margin:0 auto; padding:18px; display:flex; flex-direction:column; gap:14px; }
  .card{ background:var(--panel); border:1px solid var(--br); border-radius:12px; padding:14px; }
  .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .col{ display:flex; flex-direction:column; gap:8px; }
  input{ background:#0b1220; border:1px solid var(--br); border-radius:8px; padding:10px; color:#e5e7eb; }
  button{ background:var(--btn); color:#000; border:none; border-radius:8px; padding:10px 14px; font-weight:800; cursor:pointer; }
  button.secondary{ background:#2b3445; color:#e5e7eb; }
  button.red{ background:#b91c1c; color:#fff; }
  .muted{ color:var(--muted); }
  .list{ display:flex; flex-direction:column; gap:8px; }
  .item{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border:1px solid var(--br); border-radius:10px; background:#0f1624; }
  .left{ display:flex; align-items:center; gap:10px; }
  .avatar{ width:36px; height:36px; border-radius:999px; object-fit:cover; border:1px solid #233047; background:#0b1220; }
  .pill{ padding:2px 8px; border-radius:999px; font-weight:800; background:#0b1220; border:1px solid var(--br); }
  .toolbar{ display:flex; gap:8px; align-items:center; justify-content:space-between; }
  .grow{ flex:1 }
</style>
</head>
<body>
<div class="wrap">
  <h1 style="text-align:center;margin:6px 0 4px;">ADMIN PANEL</h1>

  <section class="card"><div class="row">
    <input id="adminkey" class="grow" type="password" placeholder="x-admin-key">
    <button id="btn-set">Set</button>
    <span id="msg" class="muted"></span>
  </div></section>

  <section class="card">
    <div class="toolbar">
      <div class="row grow">
        <input id="filter" class="grow" type="text" placeholder="Traži po nicku…">
        <button class="secondary" id="btn-reload">Osvježi</button>
      </div>
      <div class="row">
        <span class="muted">Sort:</span>
        <button class="secondary" id="sort-nick">Nick</button>
        <button class="secondary" id="sort-balance">Balance</button>
        <button class="secondary" id="sort-id">ID</button>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="row">
      <input id="nick" class="grow" type="text" placeholder="nickname korisnika">
      <input id="amount" type="number" placeholder="čipovi (+ dodaj, - oduzmi)">
      <button id="btn-apply">Primijeni</button>
      <button id="btn-disable" class="red">DISABLE</button>
      <button id="btn-enable">ENABLE</button>
    </div>
    <div id="op-msg" class="muted" style="margin-top:6px;"></div>
  </section>

  <section class="card">
    <div class="row" style="justify-content:space-between;">
      <div class="muted">Korisnici</div>
      <div class="pill" id="count">0</div>
    </div>
    <div id="users" class="list" style="margin-top:10px;">—</div>
  </section>
</div>

<script>
(function(){
  const $ = s => document.querySelector(s);
  let KEY = "", USERS = [], SORT = "id", ASC = false;

  const setMsg = t => $("#msg").textContent = t || "";
  const setOp  = t => $("#op-msg").textContent = t || "";

  async function loadUsers(){
    if(!KEY){ setMsg("Unesi admin ključ."); return; }
    setMsg("Učitavanje…");
    try{
      const r = await fetch("/api/admin/users", { headers: { "x-admin-key": KEY } });
      if(!r.ok){ setMsg("HTTP greška ("+r.status+")"); return; }
      const j = await r.json();
      if(!j.ok){ setMsg(j.error || "Greška"); return; }
      USERS = j.users || [];
      setMsg("OK ("+USERS.length+")");
      render();
    }catch(_){ setMsg("Greška konekcije"); }
  }

  function render(){
    const box = $("#users");
    box.innerHTML = "";
    let list = USERS.slice();

    const q = $("#filter").value.trim().toLowerCase();
    if(q) list = list.filter(u => (u.nick || "").toLowerCase().includes(q));

    list.sort((a,b)=>{
      if(SORT==="nick"){
        const A=(a.nick||"").toLowerCase(), B=(b.nick||"").toLowerCase();
        return ASC ? A.localeCompare(B) : B.localeCompare(A);
      }
      if(SORT==="balance") return ASC ? (a.balance||0)-(b.balance||0) : (b.balance||0)-(a.balance||0);
      return ASC ? (a.id||0)-(b.id||0) : (b.id||0)-(a.id||0);
    });

    if(!list.length){
      $("#count").textContent = "0";
      box.textContent = "Nema korisnika.";
      return;
    }

    for(const u of list){
      const div = document.createElement("div");
      div.className = "item";
      const nickSafe = u.nick && u.nick.trim() ? u.nick : "—";
      div.innerHTML = `
        <div class="left">
          <img class="avatar" src="${u.avatar || '/avatar_1.png'}">
          <div>
            <div style="font-weight:800">${nickSafe}
              ${u.disabled ? ' <span class="pill" style="margin-left:6px;border-color:#b91c1c;color:#fca5a5">DISABLED</span>' : ''}
            </div>
            <div class="muted">ID: ${u.id}${u.email ? ' • '+u.email : ''}</div>
          </div>
        </div>
        <div class="left">
          <div class="pill">${Math.floor(u.balance || 0)} čipova</div>
          <button class="secondary selectBtn">Select</button>
        </div>`;
      div.querySelector(".selectBtn").onclick = () => {
        $("#nick").value = u.nick || "";
        setOp("Korisnik odabran: " + (u.nick || u.id));
      };
      box.appendChild(div);
    }

    $("#count").textContent = String(list.length);
  }

  async function post(path, body){
    try{
      const r = await fetch(path, {
        method: "POST",
        headers: { "Content-Type":"application/json", "x-admin-key": KEY },
        body: JSON.stringify(body || {})
      });
      return await r.json();
    }catch(_){ return { ok:false, error:"network" }; }
  }

  $("#btn-set").onclick = ()=>{
    KEY = $("#adminkey").value.trim();
    if(!KEY){ setMsg("Unesi admin ključ."); return; }
    setMsg("Admin ključ postavljen.");
    loadUsers();
  };

  $("#btn-reload").onclick   = loadUsers;
  $("#filter").oninput       = render;
  $("#sort-nick").onclick    = ()=>{ SORT="nick";     ASC=!ASC; render(); };
  $("#sort-balance").onclick = ()=>{ SORT="balance";  ASC=!ASC; render(); };
  $("#sort-id").onclick      = ()=>{ SORT="id";       ASC=!ASC; render(); };

  $("#btn-apply").onclick = async ()=>{
    const nick   = $("#nick").value.trim();
    const amount = Number($("#amount").value || 0);
    if(!nick || !amount){ setOp("Unesi nickname i iznos."); return; }
    const r = await post("/api/admin/chips", { nick, amount });
    if(r.ok){ setOp("Uspješno."); loadUsers(); }
    else setOp("Greška: " + (r.error || "nepoznato"));
  };

  $("#btn-disable").onclick = async ()=>{
    const nick = $("#nick").value.trim(); if(!nick){ setOp("Unesi nickname."); return; }
    const r = await post("/api/admin/disable", { nick, flag:1 });
    if(r.ok){ setOp("Korisnik DISABLED."); loadUsers(); }
    else setOp("Greška: " + (r.error || "nepoznato"));
  };

  $("#btn-enable").onclick = async ()=>{
    const nick = $("#nick").value.trim(); if(!nick){ setOp("Unesi nickname."); return; }
    const r = await post("/api/admin/disable", { nick, flag:0 });
    if(r.ok){ setOp("Korisnik ENABLED."); loadUsers(); }
    else setOp("Greška: " + (r.error || "nepoznato"));
  };

  $("#adminkey").focus();
})();
</script>
</body>
</html>
